<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml"
         creationComplete="init_service()"
         width="100%"
         height="100%"
         fontSize="12">
    <mx:Button label="refresh"
               id="refresh"
               click="refreshHandler()"/>
    <mx:DataGrid width="100%"
                 height="100%"
                 dataProvider="{dp}"
                 dragEnabled="true"
                 dragMoveEnabled="false"
                 dragEnter="dragEnterHandlerForRemove(event)"
                 dragDrop="dragDropHandlerForRemove(event)">
        <mx:Script>
            <![CDATA[
                import com.yspay.pool.QueryObject;
                import com.yspay.pool.DBTable;
                import com.yspay.pool.QueryWithIndex;
                import com.yspay.pool.Pool;
                import mx.collections.ArrayCollection;
                import flash.events.Event;
                import flash.net.SharedObject;
                import com.yspay.pool.DBTableInsertEvent;
                import com.yspay.pool.DBTableQueryEvent;
                import mx.containers.Form;
                import mx.containers.FormItem;
                import mx.containers.HBox;
                import mx.containers.TitleWindow;
                import mx.controls.*;
                import mx.core.Application;
                import mx.core.UIComponent;
                import mx.events.*;
                import mx.managers.DragManager;
                import mx.rpc.events.ResultEvent;
                import mx.rpc.http.mxml.HTTPService;
                import mx.states.State;
                import mx.utils.StringUtil;
                import com.yspay.*;
                import com.yspay.util.FunctionDelegate;
                import mx.managers.CursorManager;

                [Bindable]
                private var dp:ArrayCollection = new ArrayCollection;
                private var _pool:Pool;

                private function init_service():void
                {

                    _pool = this.parentDocument._pool as Pool;
                    onInit_service();
                }

                private function onInit_service():void
                {
                    dp.removeAll();
                    var info:DBTable = _pool.info as DBTable;
                    for each (var service_obj:QueryObject in info.SERVICES)
                    {
                        var ys_var:YsVarStruct = service_obj.Get();
                        var o:Object = new Object;
                        o.name = ys_var.NAME.getValue();
                        o.dts = ys_var.DTS.getValue();
                        o.desc = ys_var.MEMO.getValue();
                        dp.addItem(o);
                    }
                    //?????????
                    for each (var action_obj:QueryObject in info.ACTIONS)
                    {
                        var ys_var1:YsVarStruct = action_obj.Get();
                        var o1:Object = new Object;
                        o1.name = ys_var1.NAME.getValue();
                        o1.dts = ys_var1.DTS.getValue();
                        o1.desc = ys_var1.MEMO.getValue();
                        dp.addItem(o1);
                    }
                }

                private function refreshHandler():void
                {
                    var info_query_service:String = 'SERVICES';
                    var info_query_service_cond:String = "type='SERVICES' and appname='MapServer'";
                    var info:DBTable = _pool.info as DBTable;
                    this.addEventListener(info.select_event_name, InfoQueryComplete);
                    info.AddQuery(info_query_service, QueryWithIndex, info_query_service_cond, this);
                    CursorManager.setBusyCursor();
                    info.DoQuery(info_query_service, 'NAME', 'VER');
                }

                private function InfoQueryComplete(event:DBTableQueryEvent):void
                {
                    CursorManager.removeBusyCursor();
                    trace("--------------------Update service in pool-----------------------")
                    trace(event.user_bus);
                    onInit_service();
                }

                private function dragEnterHandlerForRemove(event:DragEvent):void
                {
                    if (event.dragSource.hasFormat("self"))
                        DragManager.acceptDragDrop(UIComponent(event.currentTarget));
                }

                private function dragDropHandlerForRemove(event:DragEvent):void
                {
                    (event.dragInitiator as UIComponent).parent.removeChild(event.dragInitiator as UIComponent);
                }
            ]]>
        </mx:Script>
        <mx:columns>
            <mx:DataGridColumn headerText="名字"
                               dataField="name">
            </mx:DataGridColumn>
            <mx:DataGridColumn headerText="中文名字"
                               dataField="desc"/>
            <mx:DataGridColumn headerText="DTS号"
                               dataField="dts"/>
        </mx:columns>
    </mx:DataGrid>
</mx:VBox>
